---
title: "<span style='font-size: 40px'><b>Open3D</b></style> <span style='font-size: 30px'> <br> approches multi-paradigmes et <br> multi-scalaires <br> dans le contexte du Web3D et <br> de la Science ouverte</style>"
# title: "**Art rupestre** <br> approches multi-paradigmes et multi-scalaires <br> des graphies anciennes dans le contexte <br> du Web3D et de la Science ouverte"
abstract: "A web 3D multi-paradigm and multi-scalar presentation of lithic tools and ancient iconography (rock-art, hieroglyphs). 3D data management with open-source softwares (GitHub, 3DHOP, Blender, R, JavaScript, etc.) within the frame of Linked-Open data (LOD)" 
author: "Thomas Huet"
# date: "4/26/2021"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r, echo=FALSE}
url.root <- "https://raw.githubusercontent.com/zoometh/thomashuet/main/img/"
htmltools::img(src = paste0(url.root, "prj_rockart.png"), 
               alt = 'logo', 
               width = '150px',
               style = 'position:absolute; top:0; right:0; padding:10px;')
```

---

<style>
.html-widget {
margin: auto;
}
.leaflet .legend {
text-align:left;
line-height: 12px;
font-size: 12px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(RPostgreSQL)
library(RPostgres)
library(httr)
library(english)
library(dplyr)
library(sf)
library(knitr)
library(kableExtra)
# library(htmlwidgets)

url.3dhop <- "https://zoometh.github.io/3DHOP/minimal/"
url.html <- "https://api.github.com/repos/zoometh/3DHOP/git/trees/master?recursive=1"
url.www <- "https://raw.githubusercontent.com/zoometh/rockart/main/www/"
url.icon <- paste0(url.www, "icon_3dhop.png")


eval = TRUE

```

# Introduction

Ce document Rmarkdown (R + Markdown) alterne modèles 3D, cartes, liens, tableaux, etc. avec des "morceaux de code" informatique (i.e. *code chunks*, en fond grisé). Les données qui ont servi sont enregistrées dans deux *repository* GitHub: [zoometh/3DHOP](https://github.com/zoometh/3DHOP) qui est un *fork* de 3DHOP (*3D Heritage Online Presenter*), et où sont entreposés les données 3D, et [zoometh/rockart](https://github.com/zoometh/rockart) pour le reste des données.

## Tracéologie {#traceo}

La tracéologie est l'étude de traces souvent microscopiques sur des objets ayant des dimensions allant de quelques centimètres à plusieurs mètres. Une intégration 3D de ces différentes échelles peut permettre une meilleure compréhension des savoirs-faires (technologie, archéologie du geste, etc.) et une meilleure diffusion de ces connaissances dans la communauté scientifique et auprès du grand public via le web 3D. 

Sur chaque acquisition 3D, le dessin d'une [zone d'intérêt](#roi) permet de localiser les traces d'utilisation et de lier ce modèle 3D avec un autre modèle 3D obtenu à une échelle inférieure. Dans cet exemple, nous travaillons à l'intégration de modèles 3D issus de [trois échelles différentes](#scales). 


### Dessin des zones d'intérêt {#roi}

Le dessin des zone d'intérêt (*Region of Interest*, ou ROI) est une surface 3D dessinée directement sur l'objet depuis un logiciel d'édition 3D (e.g. Blender).

<center>

![Dessin de la ROI (en vert) comme surface 3D sur le modèle 3D (en gris) dans le logiciel Blender](https://raw.githubusercontent.com/zoometh/rockart/main/www/blender_roi.png){width=450px}

</center>

L'objet (échelle supérieure) et la surface 3D (échelle inférieure) sont enregistrés au format `.ply`. L'objet est transformé en `.nxz`, un format adapté pour le streaming 3D, avec l'application [Nexus](http://vcg.isti.cnr.it/nexus/). Ces modèles, sont ensuite intégrés dans le [framework 3DHOP](http://www.3dhop.net/) et stockés dans le *fork*  du dépôt GitHub [zoometh/3DHOP](https://github.com/zoometh/3DHOP/tree/master/minimal).

<center>

![Schéma de travail pour l'exposition d'un modèle 3D sur le web](https://raw.githubusercontent.com/zoometh/rockart/main/www/workflow.png){width=650px}

</center>

Ci-dessous nous présentons une capture d'écran d'un modèle 3D d'un outil expérimental avec la ROI (à gauche en bleu, peu visible) localisant (grossièrement) les traces d'utilisation. Cette ROI est activable ou desactivable avec le boution 3DHOP ![](https://raw.githubusercontent.com/zoometh/rockart/main/www/icon_3dnotation.png){width=35px}. Quand la ROI est clickée, elle peut ouvrir une nouvelle page HTML avec le modèle 3D à l'échelle inférieure

```{r, echo=FALSE, out.width="40%", out.height="20%", fig.cap="Modèle 3D intégré dans le *framework* 3DHOP ", fig.show='hold', fig.align='center'}
knitr::include_graphics(c(paste0(url.www, "3DHOP_lithic_roi.png"),
                          paste0(url.www,"3DHOP_lithic_roi_clicked.png"))
)
```

Ce modèle peut être consulté à cette URL:  

<center><https://zoometh.github.io/3DHOP/minimal/lithic_tool.html></center>

### Echelles {#scales}



```{r lithicdf, echo=F, fig.align="center"}
df.3Dscales <- data.frame(echelle = c("macro", "meso", "micro"),
                          mesures = c("cm", "mm", "$\\mu$m"),
                          instrument = c("Laser", "HIROX", "ConFocal"))
kable(df.3Dscales,"html",
      row.names = F,
      caption = "Approche 3D multi-scalaire") %>%
  collapse_rows(columns = c(1, 2), col_names = "echelle") %>%
  kable_styling(full_width = FALSE,
                position = "center",
                font_size = 12)
```


#### Macro

Acquisition de l'objet avec un laser, ou en photogrammétrie  

<center>

![Acquisition avec le Laser de lumière structurée smart SCAN 3D Breuckman (IMF-CSIC)](https://raw.githubusercontent.com/zoometh/rockart/main/www/stl.jpg){width=450px}

</center>

#### Meso

HIROX

#### Micro

ConFocal

## Art rupestre

Nous présentons ci-dessous, un essai de FAIRisation des données liées aux graphies anciennes (art rupestre, hiéroglyphes) en nous focalisant sur la cartogaphie et la 3D. Ici, nous prenons ces deux (2) sites en exemple:


```{r mapgen, echo=F, fig.align="center"}
# TODO: internal hyperlink to sites
# D3HOP.root <- "https://zoometh.github.io/3DHOP/minimal/"
Karnak <- c("Karnak", 32.65731321534125, 25.719743198412978)
Bego <- c("Mont Bego", 7.4380446386350165, 44.07579327562306)
sites.df <- as.data.frame(rbind(Karnak, Bego), stringsAsFactors = F)
names(sites.df) <- c("nom", "x", "y")
sites.df$url <- paste0("[", sites.df$nom, "](#", sites.df$nom, ")")
# sites.df$url <- paste0('<a href=', shQuote(paste0(url.sith, locus$KIU)),
#                     "\ target=\"_blank\"",">", paste0("KIU",locus$KIU), "</a>")
leaflet(width = "400px", height = "400px", options = leafletOptions(zoomControl = FALSE)) %>%
  addProviderTiles("Esri.WorldImagery", group = "Ortho") %>%
  addLabelOnlyMarkers(data = sites.df,
                      lng = ~as.numeric(x),
                      lat = ~as.numeric(y),
                      label = ~nom,
                      labelOptions = labelOptions(noHide = T, direction = 'top'))
```
&nbsp;

Pour chacun de ces sites, le logo ![](https://raw.githubusercontent.com/zoometh/rockart/main/www/icon_3dhop.png){width=25px} signale l'existence d'un modèle 3D

### Mont Bego {#Bego}

La région du mont Bégo (Alpes-Maritimes, France) est surtout connue pour son art rupestre avec un nombre  impressionnant de roches gravées, mais le site est aussi l'un des premiers de montagne à être occupé au début du Néolithique (ca. -5300 BC)

#### Données

Actuellement, les données sont stockées dans une base de données Postgres 13 locale. Ici, nous sélectionnons quelques champs - y compris les coordonnées géographiques - et les exportons dans un fichier `.csv` stocké dans le dépôt GitHub.

```{r begodb, eval=F}
drv <- dbDriver("PostgreSQL")
con <- dbConnect(RPostgres::Postgres(),
                 dbname = "bego_20_04_2021",
                 host="localhost",
                 port=5433,
                 user="postgres",
                 password="postgres")  
sqll <- "SELECT idroche, nom, x, y, z FROM roches_spat"
roches.all <- dbGetQuery(con,sqll)
roches.all$idroche <- gsub("\\.", "\\_", roches.all$idroche )
write.csv(roches.all, "data/roches_all.csv", row.names = F)
dbDisconnect(con)
```

Certaines roches gravées ont été modélisées en 3D par photogrammétrie (logiciel commercial [Metashape Photoscan](https://www.agisoft.com/)) au format 3D (`.obj` ou `.ply`). Une application commerciale comme [Sketchfab](https://sketchfab.com) permet de mettre un modèle 3D en ligne et d'intégrer un conteneur `<iframe>` vers ce modèle. Comme ici:

<center>

<iframe title="Roche de l'archer (ZXVIII.GI.R28@a)" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="fullscreen; autoplay; vr" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share src="https://sketchfab.com/models/a5c0771d898d4816950570cd7fb1be37/embed"> </iframe>

</center>


Dans le domaine du libre, ces modèles une fois transformés sont manipulés avec le [framework 3DHOP](http://www.3dhop.net/) et stockés dans le *fork*  du dépôt GitHub [zoometh/3DHOP](https://github.com/zoometh/3DHOP/tree/master/minimal). Dans le `code chunk` ci-dessous, nous lisons le contenu du dossier 'minimal' pour obtenir les noms de ces modèles (stockés en tant que fichiers `.nxz` dans le dossier 'models').

```{r read, eval=eval}
roches.all <- read.csv("data/roches_all.csv")
req <- GET(url.html)
stop_for_status(req)
filelist <- unlist(lapply(content(req)$tree, "[", "path"), use.names = F)
D3.models <- grep("minimal/.*html$", filelist, value = TRUE)
D3.models <- gsub("minimal/", "", D3.models)
D3.models <- sort(gsub(".html$", "", D3.models))
nm.models <- roches.all[roches.all$idroche %in% D3.models, "nom"]
l.nm.models <- paste0(paste0("*", nm.models, "* (", D3.models,")"))
nb.models <- length(D3.models)
```

Actuellement, il existe `r nb.models` modèles 3D: `r l.nm.models`

#### Cartographie

Nous lions les URL des roches gravées modélisées en 3D par jointure sur leur identifiant (e.g., 7_1_8) dans la table des roches -- pour les ouvrir directement à partir de la carte *Leaflet* --, et nous attribuons à ces roches une icône personnalisée ([icône '3DHOP'](https://raw.githubusercontent.com/zoometh/rockart/main/www/icon_3dhop.png))

```{r mapbego, eval=eval}
roches.3D <- roches.all[roches.all$idroche %in% D3.models, ]
roches.others <- roches.all[!(roches.all$idroche %in% D3.models), ]
roches.3D.icons <- icons(
  iconUrl = url.icon,
  iconWidth = 40, iconHeight = 56,
  iconAnchorX = 20, iconAnchorY = 28
)
roches.3D$desc <- paste0("roche: ", roches.3D$idroche, '<br> 3D model: <a href=',
                         shQuote(paste0(url.3dhop, roches.3D$idroche, ".html")),
                         "\ target=\"_blank\"",">", roches.3D$nom, "</a>")
roches.others$desc <- paste0("roche: ", roches.others$idroche)
leaflet(width = "700px", height = "700px") %>%
  addTiles(group = 'OSM') %>%
  addProviderTiles("Esri.WorldImagery", group = "Ortho") %>%
  addCircleMarkers(data = roches.others,
                   lng = ~x,
                   lat = ~y,
                   popup = ~desc,
                   color = "red",
                   radius = 0.5,
                   opacity = 0.8) %>%
  addMarkers(data = roches.3D,
             lng = ~x,
             lat = ~y,
             popup = ~desc,
             icon = roches.3D.icons) %>%
  addLayersControl(
    baseGroups = c('Ortho', 'OSM')) %>%
  addScaleBar(position = "bottomleft")
```
&nbsp;

Certains de ces modèles 3D ont des annotations, comme la *Roche de l'homme aux bras en zigzag*, ou la *Stèle du Chef de Tribu*

## Karnak {#Karnak}

En Haute-Egypte, le complexe cultuel de Karnak (temples, pylos, chapelles, etc.) se développe au cours du Nouvel Empire, corrélativement au culte d'Amon. Le site est étudié depuis près de 150 ans par une équipe d'égyptologues français. La documentation de ces monuments en 3D, et l'interopérabilité de ces modèles 3D, peut permettre de mieux comprendre l'évolution des hiéroglyphes dans le temps (paléographie)

### Données

Le jeu de données correspond à un fichier .csv ([locus.csv](https://github.com/zoometh/rockart/blob/main/www/locus.csv)) conservé sur GitHub

```{r karnakdb, eval=eval}
locus <- read.csv("www/locus.csv", sep = ";", row.names = NULL)
kable(locus, "html", escape = FALSE,
      caption = "Données Karnak") %>%
  kable_styling(bootstrap_options = c("hover", "condensed"), font_size=12)
```

Les liens entre ces données et leurs identifiants [KIU (*Karnak Identifiant Unique*)](http://sith.huma-num.fr/karnak/) -- qui sont égalment des URL-- sont générés par concatenation

```{r karnakbdmanip, eval=eval}
url.sith <- "http://sith.huma-num.fr/karnak/"
locus$url <- paste0('<a href=', shQuote(paste0(url.sith, locus$KIU)),
                    "\ target=\"_blank\"",">", paste0("KIU",locus$KIU), "</a>")
```

Le (très beau) modèle 3D de KIU2610, nous est fourni par [Sketchfab](https://sketchfab.com/3d-models/karnak-holy-of-holies-south-exterior-77e3e1eba8cc49fe8c04d6b3343b9dc4) 

<center>

<iframe title="KIU2610" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="fullscreen; autoplay; vr" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share src="https://sketchfab.com/models/77e3e1eba8cc49fe8c04d6b3343b9dc4/embed"> </iframe>

</center>

Ce modèle est ouvert dans Blender et une nouvelle géométrie (un mesh) sur une partie de sa surface pour signaler un panneau (KIU2613). Ce panneau est donc un sous-ensemble de KIU2160

### Cartographie

Ces données sont comparées avec les modèles 3D existant dans le repository GitHub [zoometh/3DHOP](https://github.com/zoometh/3DHOP/tree/master/minimal)

```{r mapkarnak, eval=eval}
req <- GET(url.html)
stop_for_status(req)
filelist <- unlist(lapply(content(req)$tree, "[", "path"), use.names = F)
D3.models <- grep("minimal/.*html$", filelist, value = TRUE)
D3.models <- gsub("minimal/", "", D3.models)
D3.models <- sort(gsub(".html$", "", D3.models))
nm.models <- locus[locus$url %in% D3.models, "D3"]
nb.models <- length(nrow(nm.models))

monum.3D <- locus[locus$D3 %in% D3.models, ]
monum.others <- locus[!(locus$D3 %in% D3.models), ]
monum.3D.icons <- icons(
  iconUrl = url.icon,
  iconWidth = 40, iconHeight = 56,
  iconAnchorX = 0, iconAnchorY = 0
)
monum.3D$desc <- paste0(monum.3D$url, " : ", monum.3D$nom, '<br><a href=',
                        shQuote(paste0(url.3dhop, monum.3D$D3, ".html")),
                        "\ target=\"_blank\"",">","<b> modèle 3D </b>", "</a>")
monum.others$desc <- paste0(monum.others$url, " : ", monum.others$nom)
leaflet(width = "700px", height = "700px") %>%
  addTiles(group = 'OSM') %>%
  addProviderTiles("Esri.WorldImagery", group = "Ortho") %>%
  addCircleMarkers(data = monum.others,
                   lng = ~X,
                   lat = ~Y,
                   popup = ~desc,
                   color = ~couleur,
                   radius = 15,
                   opacity = .5) %>%
  addMarkers(data = monum.3D,
             lng = ~X,
             lat = ~Y,
             popup = ~desc,
             icon = monum.3D.icons) %>%
  addLayersControl(
    baseGroups = c('Ortho', 'OSM')) %>%
  addScaleBar(position = "bottomleft")
```
